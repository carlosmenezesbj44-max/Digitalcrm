{% extends "layout.html" %}

{% block title %}Faturas - CRM Provedor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h1 class="h3 mb-0" style="color: var(--text-main); font-weight: 700;"><i class="bi bi-receipt"></i> Faturas</h1>
            <p style="color: var(--text-secondary); opacity: 0.8;" class="mb-0">Gerencie as faturas dos clientes</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select border-secondary bg-transparent text-white" id="clienteSelecionado" style="width: 200px;" onchange="mostrarValorCliente()">
                <option value="" class="bg-dark">Selecione um cliente...</option>
            </select>
            <button class="btn btn-primary border-0 shadow-sm px-4" onclick="gerarFaturaCliente()" id="btnGerarFatura" disabled>
                <i class="bi bi-plus-circle"></i> Gerar Fatura
            </button>
            <button class="btn btn-outline-secondary border-secondary" onclick="gerarFaturasMensais()">
                <i class="bi bi-calendar-plus"></i> Gerar para Todos
            </button>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger bg-opacity-10 border-danger border-opacity-25 text-danger" role="alert">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    <!-- Filtros -->
    <div class="card mb-4 border-0 shadow-sm" style="background: var(--card-bg);">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Cliente</label>
                    <select class="form-select border-secondary bg-transparent text-white" id="filtroCliente">
                        <option value="" class="bg-dark">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Status</label>
                    <select class="form-select border-secondary bg-transparent text-white" id="filtroStatus">
                        <option value="" class="bg-dark">Todos</option>
                        <option value="pendente" class="bg-dark">Pendente</option>
                        <option value="pago" class="bg-dark">Pago</option>
                        <option value="atrasado" class="bg-dark">Atrasado</option>
                        <option value="cancelado" class="bg-dark">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Mês/Ano</label>
                    <input type="month" class="form-control border-secondary bg-transparent text-white" id="filtroMes">
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-primary btn-sm w-100 border-primary border-opacity-25" onclick="filtrarFaturas()">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Card de Prévia da Fatura -->
    <div class="card mb-4 d-none border-0 shadow-sm" id="cardPreviaFatura" style="background: var(--card-bg);">
        <div class="modal-header border-bottom-0 pt-4 px-4">
            <h6 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-info-circle"></i> Prévia da Fatura a Ser Gerada</h6>
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-6">
                    <p style="color: var(--text-main);"><strong style="color: var(--text-secondary);">Cliente:</strong> <span id="previaCliente">-</span></p>
                    <p style="color: var(--text-main);"><strong style="color: var(--text-secondary);">Plano:</strong> <span id="previaPlano">-</span></p>
                </div>
                <div class="col-md-6">
                    <p style="color: var(--text-main);"><strong style="color: var(--text-secondary);">Valor Mensal:</strong> R$ <span id="previaValor">-</span></p>
                    <p style="color: var(--text-main);"><strong style="color: var(--text-secondary);">Vencimento:</strong> <span id="previaVencimento">-</span></p>
                </div>
            </div>
            <div class="alert alert-info bg-opacity-10 border-info border-opacity-25 text-info border-0 shadow-sm mt-3">
                <i class="bi bi-lightbulb"></i>
                <strong>A fatura será gerada com o valor mensal do plano do cliente.</strong>
            </div>
        </div>
    </div>

    <!-- Tabela de Faturas -->
    <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
        <div class="modal-header border-bottom-0 pt-4 px-4">
            <h6 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-table"></i> Faturas Registradas</h6>
        </div>
        <div class="card-body p-4">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tabelaFaturas">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th style="color: var(--text-main);">ID</th>
                            <th style="color: var(--text-main);">Número</th>
                            <th style="color: var(--text-main);">Cliente</th>
                            <th style="color: var(--text-main);">Valor</th>
                            <th style="color: var(--text-main);">Status</th>
                            <th style="color: var(--text-main);">Vencimento</th>
                            <th style="color: var(--text-main);">Valor Pago</th>
                            <th class="text-end" style="color: var(--text-main);">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela" class="border-top-0">
                        <tr><td colspan="8" class="text-center py-4" style="color: var(--text-secondary);">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registrar Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow" style="background: var(--card-bg); color: var(--text-main);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);">Registrar Pagamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 pb-4">
                <form id="formPagamento">
                    <input type="hidden" id="pagamentoFaturaId">
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: var(--text-main);">Valor Pago</label>
                        <input type="number" step="0.01" class="form-control border-secondary bg-transparent text-white" id="valorPago" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: var(--text-main);">Método de Pagamento</label>
                        <select class="form-select border-secondary bg-transparent text-white" id="metodoPagamento" required>
                            <option value="boleto" class="bg-dark">Boleto</option>
                            <option value="pix" class="bg-dark">PIX</option>
                            <option value="cartao" class="bg-dark">Cartão</option>
                            <option value="dinheiro" class="bg-dark">Dinheiro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: var(--text-main);">Data do Pagamento</label>
                        <input type="date" class="form-control border-secondary bg-transparent text-white" id="dataPagamento" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold" style="color: var(--text-main);">Referência</label>
                        <input type="text" class="form-control border-secondary bg-transparent text-white" id="referencia" placeholder="Código do boleto, ID PIX, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0 px-4 pb-4">
                <button type="button" class="btn btn-outline-secondary btn-sm border-secondary border-opacity-25" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success btn-sm border-0 shadow-sm px-4" onclick="registrarPagamento()">Registrar Pagamento</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let faturas = [];
    let clientes = [];

    document.addEventListener('DOMContentLoaded', async function() {
        await carregarClientes();
        await carregarFaturas();
    });

    async function carregarClientes() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/v1/clientes/?page=1&per_page=100', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                clientes = Array.isArray(data) ? data : (data.clientes || []);
                
                const selectFiltro = document.getElementById('filtroCliente');
                const selectGerar = document.getElementById('clienteSelecionado');

                let opcaoFiltro = '<option value="">Todos</option>';
                let opcaoGerar = '<option value="">Selecione um cliente...</option>';

                clientes.forEach(cliente => {
                    opcaoFiltro += `<option value="${cliente.id}">${cliente.nome}</option>`;
                    opcaoGerar += `<option value="${cliente.id}">${cliente.nome}</option>`;
                });

                selectFiltro.innerHTML = opcaoFiltro;
                selectGerar.innerHTML = opcaoGerar;
                window.clientesData = clientes;
            }
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
        }
    }

    async function carregarFaturas() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/v1/faturas/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const faturasData = await response.json();
                faturas = faturasData.map(fatura => {
                    const cliente = (window.clientesData || []).find(c => c.id == fatura.cliente_id);
                    fatura.cliente_nome = cliente ? cliente.nome : `Cliente ${fatura.cliente_id}`;
                    return fatura;
                });
                renderizarFaturas(faturas);
            } else {
                document.getElementById('corpoTabela').innerHTML = 
                    '<tr><td colspan="8" class="text-center text-muted">Nenhuma fatura encontrada</td></tr>';
            }
        } catch (error) {
            console.error('Erro ao carregar faturas:', error);
            document.getElementById('corpoTabela').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar faturas</td></tr>';
        }
    }

    function renderizarFaturas(faturasFiltradas) {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = '';

        if (faturasFiltradas.length === 0) {
            corpo.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Nenhuma fatura encontrada</td></tr>';
            return;
        }

        const statusClass = {
            'pendente': 'badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25',
            'pago': 'badge bg-success bg-opacity-10 text-success border border-success border-opacity-25',
            'atrasado': 'badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25',
            'cancelado': 'badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25'
        };

        faturasFiltradas.forEach(fatura => {
            const linha = `
                <tr>
                    <td style="color: var(--text-main);">${fatura.id}</td>
                    <td style="color: var(--text-main);">${fatura.numero_fatura}</td>
                    <td style="color: var(--text-main);">${fatura.cliente_nome}</td>
                    <td style="color: var(--text-main);">R$ ${fatura.valor_total.toFixed(2)}</td>
                    <td><span class="${statusClass[fatura.status] || 'badge bg-secondary bg-opacity-10 text-secondary'}" style="font-weight: 500;">${fatura.status}</span></td>
                    <td style="color: var(--text-main);">${new Date(fatura.data_vencimento).toLocaleDateString('pt-BR')}</td>
                    <td style="color: var(--text-main);">R$ ${fatura.valor_pago.toFixed(2)}</td>
                    <td class="text-end">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success border-success border-opacity-25" onclick="abrirModalPagamento(${fatura.id})" title="Registrar Pagamento">
                                <i class="bi bi-cash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info border-info border-opacity-25" onclick="verDetalhes(${fatura.id})" title="Ver Detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            corpo.innerHTML += linha;
        });
    }

    function filtrarFaturas() {
        const clienteId = document.getElementById('filtroCliente').value;
        const status = document.getElementById('filtroStatus').value;
        const mes = document.getElementById('filtroMes').value;

        let filtradas = faturas;

        if (clienteId) {
            filtradas = filtradas.filter(f => f.cliente_id == clienteId);
        }
        if (status) {
            filtradas = filtradas.filter(f => f.status === status);
        }
        if (mes) {
            filtradas = filtradas.filter(f => f.data_vencimento.startsWith(mes));
        }

        renderizarFaturas(filtradas);
    }

    async function mostrarValorCliente() {
        const clienteId = document.getElementById('clienteSelecionado').value;
        const cardPrevia = document.getElementById('cardPreviaFatura');
        const btnGerar = document.getElementById('btnGerarFatura');

        if (!clienteId) {
            cardPrevia.classList.add('d-none');
            btnGerar.disabled = true;
            return;
        }

        const cliente = window.clientesData?.find(c => c.id == clienteId);
        if (!cliente) return;

        const hoje = new Date();
        const diaVencimento = cliente.dia_vencimento || 5;
        let dataVencimento;
        if (hoje.getDate() < diaVencimento) {
            dataVencimento = new Date(hoje.getFullYear(), hoje.getMonth(), diaVencimento);
        } else {
            dataVencimento = new Date(hoje.getFullYear(), hoje.getMonth() + 1, diaVencimento);
        }

        document.getElementById('previaCliente').textContent = cliente.nome;
        document.getElementById('previaPlano').textContent = cliente.plano_id ? `Plano ${cliente.plano_id}` : 'Sem plano';
        document.getElementById('previaValor').textContent = cliente.valor_mensal ? cliente.valor_mensal.toFixed(2) : '0.00';
        document.getElementById('previaVencimento').textContent = dataVencimento.toLocaleDateString('pt-BR');

        cardPrevia.classList.remove('d-none');
        btnGerar.disabled = false;
    }

    function abrirModalPagamento(faturaId) {
        document.getElementById('pagamentoFaturaId').value = faturaId;
        document.getElementById('valorPago').value = '';
        document.getElementById('dataPagamento').value = new Date().toISOString().split('T')[0];
        new bootstrap.Modal(document.getElementById('modalPagamento')).show();
    }

    async function registrarPagamento() {
        const faturaId = document.getElementById('pagamentoFaturaId').value;
        const valorPago = document.getElementById('valorPago').value;
        const metodo = document.getElementById('metodoPagamento').value;
        const dataPagamento = document.getElementById('dataPagamento').value;
        const referencia = document.getElementById('referencia').value;

        showLoading('Registrando pagamento...');

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/faturas/${faturaId}/marcar-paga`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ valor_pago: valorPago, metodo, data_pagamento: dataPagamento, referencia })
            });

            const data = await response.json();
            if (data.success) {
                showToast('Pagamento registrado!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
                await carregarFaturas();
            } else {
                showToast(data.message || 'Erro', 'error');
            }
        } catch (error) {
            showToast('Erro ao registrar pagamento', 'error');
        } finally {
            hideLoading();
        }
    }

    function verDetalhes(faturaId) {
        window.location.href = `/faturas/${faturaId}`;
    }

    async function gerarFaturaCliente() {
        const clienteId = document.getElementById('clienteSelecionado').value;
        if (!clienteId) return;

        const hoje = new Date();
        const mes = hoje.getMonth() + 1;
        const ano = hoje.getFullYear();

        showLoading('Gerando fatura...');
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/faturas/gerar-mensal/${mes}/${ano}?cliente_id=${clienteId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.faturas && data.faturas.length > 0) {
                showToast('Fatura gerada!', 'success');
                await carregarFaturas();
            } else {
                showToast('Já existe fatura para este mês/ano', 'warning');
            }
        } catch (error) {
            showToast('Erro ao gerar fatura', 'error');
        } finally {
            hideLoading();
        }
    }

    async function gerarFaturasMensais() {
        if (!confirm('Gerar faturas para todos os clientes?')) return;
        const hoje = new Date();
        const mes = hoje.getMonth() + 1;
        const ano = hoje.getFullYear();
        showLoading('Gerando faturas...');
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/v1/faturas/gerar-mensal/${mes}/${ano}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            if (data.faturas) {
                showToast(`${data.faturas.length} faturas geradas!`, 'success');
                await carregarFaturas();
            } else {
                showToast('Erro ao gerar faturas', 'error');
            }
        } catch (error) {
            showToast('Erro ao gerar faturas', 'error');
        } finally {
            hideLoading();
        }
    }
</script>
{% endblock %}
