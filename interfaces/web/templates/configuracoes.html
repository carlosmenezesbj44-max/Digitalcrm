{% extends "layout.html" %}

{% block title %}Configurações - CRM Provedor{% endblock %}

{% block extra_css %}
<style>
    .config-section {
        margin-bottom: 30px;
    }
    .config-section h4 {
        color: var(--text-main);
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 700;
        letter-spacing: -0.5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h1 class="h3 mb-0" style="color: var(--text-main); font-weight: 700;"><i class="bi bi-gear"></i> Configurações do Sistema</h1>
            <p style="color: var(--text-secondary); opacity: 0.8;" class="mb-0">Configure integrações e parâmetros do sistema</p>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger border-0 shadow-sm" role="alert" style="background: rgba(231, 76, 60, 0.1); color: #e74c3c;">
        <i class="bi bi-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success border-0 shadow-sm" role="alert" style="background: rgba(46, 204, 113, 0.1); color: #2ecc71;">
        <i class="bi bi-check-circle"></i> {{ success }}
    </div>
    {% endif %}

    <!-- Configurações Gerencianet -->
    <div class="config-section">
        <h4><i class="bi bi-bank"></i> Integração Gerencianet</h4>
        <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-gear"></i> Credenciais da API</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="formGerencianet">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gerencianetClientId" class="form-label fw-bold" style="color: var(--text-main);">
                                    Client ID
                                    <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Obtenha em https://gerencianet.com.br</small>
                                </label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="gerencianetClientId" placeholder="Seu Client ID">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gerencianetClientSecret" class="form-label fw-bold" style="color: var(--text-main);">
                                    Client Secret
                                    <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Mantido em segredo</small>
                                </label>
                                <input type="password" class="form-control border-secondary bg-transparent text-white" id="gerencianetClientSecret" placeholder="Seu Client Secret">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="gerencianetSandbox" class="form-label fw-bold" style="color: var(--text-main);">Modo</label>
                                <select class="form-select border-secondary bg-transparent text-white" id="gerencianetSandbox">
                                    <option value="true" class="bg-dark">Sandbox (Testes)</option>
                                    <option value="false" class="bg-dark">Produção (Real)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appUrl" class="form-label fw-bold" style="color: var(--text-main);">
                                    URL da Aplicação
                                    <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Para webhook (ex: http://localhost:8000)</small>
                                </label>
                                <input type="url" class="form-control border-secondary bg-transparent text-white" id="appUrl" placeholder="http://localhost:8000">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="gerencianetWebhookSecret" class="form-label fw-bold" style="color: var(--text-main);">
                            Webhook Secret <span style="font-weight: normal; opacity: 0.7;">(opcional)</span>
                            <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Para validar notificações de pagamento</small>
                        </label>
                        <input type="text" class="form-control border-secondary bg-transparent text-white" id="gerencianetWebhookSecret" placeholder="Secret para webhooks">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Configurações de Email -->
    <div class="config-section">
        <h4><i class="bi bi-envelope"></i> Configurações de Email</h4>
        <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-send"></i> Servidor SMTP</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="formEmail">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpServer" class="form-label fw-bold" style="color: var(--text-main);">Servidor SMTP</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="smtpServer" placeholder="smtp.gmail.com">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="smtpPort" class="form-label fw-bold" style="color: var(--text-main);">Porta</label>
                                <input type="number" class="form-control border-secondary bg-transparent text-white" id="smtpPort" placeholder="587">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="smtpUsername" class="form-label fw-bold" style="color: var(--text-main);">Usuário</label>
                                <input type="email" class="form-control border-secondary bg-transparent text-white" id="smtpUsername" placeholder="seu@email.com">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpPassword" class="form-label fw-bold" style="color: var(--text-main);">Senha</label>
                                <input type="password" class="form-control border-secondary bg-transparent text-white" id="smtpPassword" placeholder="Senha do email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="smtpFromEmail" class="form-label fw-bold" style="color: var(--text-main);">Email Remetente</label>
                                <input type="email" class="form-control border-secondary bg-transparent text-white" id="smtpFromEmail" placeholder="noreply@sua-empresa.com">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Configurações PIX -->
    <div class="config-section">
        <h4><i class="bi bi-qr-code"></i> Configuração PIX (Recebimento)</h4>
        <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-wallet2"></i> Dados para QR Code PIX</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="formPix">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="pixTipoChave" class="form-label fw-bold" style="color: var(--text-main);">Tipo de Chave</label>
                                <select class="form-select border-secondary bg-transparent text-white" id="pixTipoChave">
                                    <option value="cpf" class="bg-dark">CPF / CNPJ</option>
                                    <option value="celular" class="bg-dark">Celular</option>
                                    <option value="email" class="bg-dark">E-mail</option>
                                    <option value="aleatoria" class="bg-dark">Chave Aleatória (EVP)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="pixChave" class="form-label fw-bold" style="color: var(--text-main);">Chave PIX</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="pixChave" placeholder="000.000.000-00 ou seu@email.com">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label fw-bold" style="color: var(--text-main);">Status nos Carnês</label>
                                <div id="pixStatusBadge" class="mt-2">
                                    <span class="badge bg-secondary">Aguardando chave...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pixBeneficiario" class="form-label fw-bold" style="color: var(--text-main);">Nome do Beneficiário</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="pixBeneficiario" placeholder="Nome do Titular da Conta">
                                <small class="text-muted">Até 25 caracteres</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pixCidade" class="form-label fw-bold" style="color: var(--text-main);">Cidade</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="pixCidade" placeholder="Sua Cidade">
                                <small class="text-muted">Até 15 caracteres (Sem acentos)</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Configurações de Negócio -->
    <div class="config-section">
        <h4><i class="bi bi-building"></i> Configurações de Negócio</h4>
        <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-cash-coin"></i> Regras Financeiras</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="formNegocio">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="boletoJurosPadrao" class="form-label fw-bold" style="color: var(--text-main);">
                                    Juros Diário (%)
                                    <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Padrão para boletos</small>
                                </label>
                                <input type="number" step="0.01" class="form-control border-secondary bg-transparent text-white" id="boletoJurosPadrao" placeholder="0.05">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="boletoMultaPadrao" class="form-label fw-bold" style="color: var(--text-main);">
                                    Multa por Atraso (%)
                                    <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Valor da multa</small>
                                </label>
                                <input type="number" step="0.01" class="form-control border-secondary bg-transparent text-white" id="boletoMultaPadrao" placeholder="2.0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="carneParcelasMax" class="form-label fw-bold" style="color: var(--text-main);">
                                    Máx. Parcelas
                                    <small class="d-block" style="color: var(--text-secondary); opacity: 0.7; font-weight: normal;">Limite para carnês</small>
                                </label>
                                <input type="number" class="form-control border-secondary bg-transparent text-white" id="carneParcelasMax" placeholder="360">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mt-4 border-0 shadow-sm" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-bank"></i> Dados Bancários</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="formBancario">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="bancoCodigo" class="form-label fw-bold" style="color: var(--text-main);">Código do Banco</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="bancoCodigo" placeholder="001">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="bancoAgencia" class="form-label fw-bold" style="color: var(--text-main);">Agência</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="bancoAgencia" placeholder="0001">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="bancoConta" class="form-label fw-bold" style="color: var(--text-main);">Conta</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="bancoConta" placeholder="123456">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="empresaCnpj" class="form-label fw-bold" style="color: var(--text-main);">CNPJ</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="empresaCnpj" placeholder="00.000.000/0000-00">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="empresaNome" class="form-label fw-bold" style="color: var(--text-main);">Razão Social</label>
                        <input type="text" class="form-control border-secondary bg-transparent text-white" id="empresaNome" placeholder="Nome da Empresa LTDA">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Configurações da Empresa -->
    <div class="config-section">
        <h4><i class="bi bi-building"></i> Dados da Empresa / Contrato</h4>
        <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);"><i class="bi bi-info-circle"></i> Informações para Contratos e Impressão</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <form id="formEmpresa">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="companyName" class="form-label fw-bold" style="color: var(--text-main);">Nome Fantasia</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="companyName" placeholder="Nome Fantasia">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="companyRazaoSocial" class="form-label fw-bold" style="color: var(--text-main);">Razão Social</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="companyRazaoSocial" placeholder="Razão Social Completa">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="companyCnpj" class="form-label fw-bold" style="color: var(--text-main);">CNPJ</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="companyCnpj" placeholder="00.000.000/0000-00">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="companyIe" class="form-label fw-bold" style="color: var(--text-main);">Inscrição Estadual</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="companyIe" placeholder="Inscrição Estadual">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="companyTelefone" class="form-label fw-bold" style="color: var(--text-main);">Telefone</label>
                                <input type="text" class="form-control border-secondary bg-transparent text-white" id="companyTelefone" placeholder="(00) 0000-0000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="companyEmail" class="form-label fw-bold" style="color: var(--text-main);">E-mail de Contato</label>
                                <input type="email" class="form-control border-secondary bg-transparent text-white" id="companyEmail" placeholder="contato@empresa.com">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="companyEndereco" class="form-label fw-bold" style="color: var(--text-main);">Endereço Completo</label>
                        <input type="text" class="form-control border-secondary bg-transparent text-white" id="companyEndereco" placeholder="Rua, Número, Bairro, Cidade - UF, CEP">
                    </div>

                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="logoInput" class="form-label fw-bold" style="color: var(--text-main);">Logo da Empresa</label>
                                <input type="file" class="form-control border-secondary bg-transparent text-white" id="logoInput" accept="image/*" onchange="uploadLogo()">
                                <input type="hidden" id="companyLogo">
                                <small style="color: var(--text-secondary); opacity: 0.7;">Formatos: PNG, JPG, SVG. Tamanho: 300x100px.</small>
                            </div>
                        </div>
                        <div class="col-md-6 text-end" id="logoPreview">
                            <!-- Logo será exibido aqui -->
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Botões de Ação -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
                <div class="card-body p-4 d-flex justify-content-between flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-secondary border-0 shadow-sm px-4" onclick="carregarConfiguracoes()" style="color: var(--text-main);">
                        <i class="bi bi-arrow-clockwise"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary border-0 shadow-sm px-4" onclick="salvarConfiguracoes()">
                        <i class="bi bi-check-lg"></i> Salvar Configurações
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Carregar configurações salvas
    document.addEventListener('DOMContentLoaded', function() {
        carregarConfiguracoes();
    });

    function carregarConfiguracoes() {
        fetch('/api/configuracoes/flat')
            .then(r => r.json())
            .then(data => {
                // Gerencianet
                document.getElementById('gerencianetClientId').value = data.gerencianet?.client_id || '';
                document.getElementById('gerencianetClientSecret').value = data.gerencianet?.client_secret || '';
                document.getElementById('gerencianetSandbox').value = data.gerencianet?.sandbox ? 'true' : 'false';
                document.getElementById('appUrl').value = data.gerencianet?.app_url || '';
                document.getElementById('gerencianetWebhookSecret').value = data.gerencianet?.webhook_secret || '';

                // PIX
                document.getElementById('pixTipoChave').value = data.pix?.pix_tipo_chave || 'cpf';
                document.getElementById('pixChave').value = data.pix?.pix_chave || '';
                document.getElementById('pixBeneficiario').value = data.pix?.pix_beneficiario || '';
                document.getElementById('pixCidade').value = data.pix?.pix_cidade || '';

                // Atualizar status do PIX
                const pixStatusBadge = document.getElementById('pixStatusBadge');
                if (data.pix?.pix_chave) {
                    pixStatusBadge.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Ativo (Sairá nos Carnês)</span>';
                } else {
                    pixStatusBadge.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Inativo (Não sairá nos Carnês)</span>';
                }

                // Email
                document.getElementById('smtpServer').value = data.email?.smtp_server || '';
                document.getElementById('smtpPort').value = data.email?.smtp_port || '';
                document.getElementById('smtpUsername').value = data.email?.smtp_username || '';
                document.getElementById('smtpPassword').value = data.email?.smtp_password || '';
                document.getElementById('smtpFromEmail').value = data.email?.smtp_from_email || '';

                // Negócio
                document.getElementById('boletoJurosPadrao').value = data.negocio?.boleto_juros_padrao || '';
                document.getElementById('boletoMultaPadrao').value = data.negocio?.boleto_multa_padrao || '';
                document.getElementById('carneParcelasMax').value = data.negocio?.carne_parcelas_max || '';

                // Bancário
                document.getElementById('bancoCodigo').value = data.bancario?.banco_codigo || '';
                document.getElementById('bancoAgencia').value = data.bancario?.banco_agencia || '';
                document.getElementById('bancoConta').value = data.bancario?.banco_conta || '';
                document.getElementById('empresaCnpj').value = data.bancario?.empresa_cnpj || '';
                document.getElementById('empresaNome').value = data.bancario?.empresa_nome || '';

                // Empresa
                document.getElementById('companyName').value = data.empresa?.company_name || '';
                document.getElementById('companyRazaoSocial').value = data.empresa?.company_razao_social || '';
                document.getElementById('companyCnpj').value = data.empresa?.company_cnpj || '';
                document.getElementById('companyIe').value = data.empresa?.company_ie || '';
                document.getElementById('companyTelefone').value = data.empresa?.company_telefone || '';
                document.getElementById('companyEmail').value = data.empresa?.company_email || '';
                document.getElementById('companyEndereco').value = data.empresa?.company_endereco || '';
                document.getElementById('companyLogo').value = data.empresa?.company_logo || '';

                // Preview do logo
                if (data.empresa?.company_logo) {
                    document.getElementById('logoPreview').innerHTML = 
                        `<img src="${data.empresa.company_logo}" alt="Logo" style="max-height: 80px;">`;
                }
            })
            .catch(err => console.error('Erro ao carregar configurações:', err));
    }

    // Atualizar badge do PIX em tempo real ao digitar
    document.getElementById('pixChave').addEventListener('input', function(e) {
        const pixStatusBadge = document.getElementById('pixStatusBadge');
        if (e.target.value.trim()) {
            pixStatusBadge.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Ativo (Sairá nos Carnês)</span>';
        } else {
            pixStatusBadge.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Inativo (Não sairá nos Carnês)</span>';
        }
    });

    function salvarConfiguracoes() {
        showLoading('Salvando configurações...');
        
        const configuracoes = {
            gerencianet: {
                client_id: document.getElementById('gerencianetClientId').value,
                client_secret: document.getElementById('gerencianetClientSecret').value,
                sandbox: document.getElementById('gerencianetSandbox').value === 'true',
                app_url: document.getElementById('appUrl').value,
                webhook_secret: document.getElementById('gerencianetWebhookSecret').value
            },
            pix: {
                pix_tipo_chave: document.getElementById('pixTipoChave').value,
                pix_chave: document.getElementById('pixChave').value,
                pix_beneficiario: document.getElementById('pixBeneficiario').value,
                pix_cidade: document.getElementById('pixCidade').value
            },
            email: {
                smtp_server: document.getElementById('smtpServer').value,
                smtp_port: parseInt(document.getElementById('smtpPort').value) || 587,
                smtp_username: document.getElementById('smtpUsername').value,
                smtp_password: document.getElementById('smtpPassword').value,
                smtp_from_email: document.getElementById('smtpFromEmail').value
            },
            negocio: {
                boleto_juros_padrao: parseFloat(document.getElementById('boletoJurosPadrao').value) || 0,
                boleto_multa_padrao: parseFloat(document.getElementById('boletoMultaPadrao').value) || 0,
                carne_parcelas_max: parseInt(document.getElementById('carneParcelasMax').value) || 12
            },
            bancario: {
                banco_codigo: document.getElementById('bancoCodigo').value,
                banco_agencia: document.getElementById('bancoAgencia').value,
                banco_conta: document.getElementById('bancoConta').value,
                empresa_cnpj: document.getElementById('empresaCnpj').value,
                empresa_nome: document.getElementById('empresaNome').value
            },
            empresa: {
                company_name: document.getElementById('companyName').value,
                company_razao_social: document.getElementById('companyRazaoSocial').value,
                company_cnpj: document.getElementById('companyCnpj').value,
                company_ie: document.getElementById('companyIe').value,
                company_telefone: document.getElementById('companyTelefone').value,
                company_email: document.getElementById('companyEmail').value,
                company_endereco: document.getElementById('companyEndereco').value,
                company_logo: document.getElementById('companyLogo').value
            }
        };

        fetch('/api/configuracoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configuracoes)
        })
        .then(r => r.json())
        .then(data => {
            if (data.message) {
                showToast('Configurações salvas com sucesso!', 'success');
                carregarConfiguracoes(); // Recarrega para atualizar os badges de status
            } else {
                showToast(data.detail || 'Erro ao salvar', 'error');
            }
        })
        .catch(() => showToast('Erro ao salvar configurações', 'error'))
        .finally(() => hideLoading());
    }

    function uploadLogo() {
        const input = document.getElementById('logoInput');
        const file = input.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('logo', file);

        showLoading('Enviando logo...');
        fetch('/api/configuracoes/upload-logo', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('companyLogo').value = data.logo_url;
                document.getElementById('logoPreview').innerHTML = 
                    `<img src="${data.logo_url}" alt="Logo" style="max-height: 80px;">`;
                showToast('Logo enviado!', 'success');
            } else {
                showToast(data.message || 'Erro ao enviar', 'error');
            }
        })
        .catch(() => showToast('Erro no upload', 'error'))
        .finally(() => hideLoading());
    }
</script>
{% endblock %}
