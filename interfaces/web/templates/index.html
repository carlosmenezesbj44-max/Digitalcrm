{% extends "layout.html" %}

{% block title %}Painel - CRM Provedor{% endblock %}

{% block extra_css %}
<style>
    /* Estilos especÃ­ficos da dashboard */
    .dashboard-wrapper {
        padding: 0;
        color: var(--text-main);
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--card-bg) 0%, #1e293b 100%);
        min-height: 100vh;
        overflow-x: hidden;
    }

    /* Top Bar Layout */
    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        gap: 16px;
        flex-wrap: wrap;
        padding: 12px 0;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 16px 24px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Top Bar Search */
    .search-group {
        display: flex;
        gap: 12px;
        flex: 1;
        max-width: 400px;
    }

    .search-select {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        border-radius: 12px;
        padding: 10px 16px;
        min-width: 140px;
        height: 48px;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .search-select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 163, 255, 0.1);
        background: rgba(255, 255, 255, 0.08);
    }

    .search-select option {
        background: #1c2833;
        color: var(--text-main);
    }

    .search-input-wrapper {
        position: relative;
        flex: 1;
        max-width: 280px;
    }

    .search-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-main);
        border-radius: 12px;
        padding: 10px 16px 10px 40px;
        height: 48px;
        transition: all 0.3s ease;
        font-size: 14px;
    }

    .search-input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 163, 255, 0.1);
        background: rgba(255, 255, 255, 0.08);
    }

    .search-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 16px;
    }

    .top-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .btn-top {
        background: linear-gradient(135deg, var(--primary-color) 0%, #007bff 100%);
        border: none;
        color: white;
        border-radius: 24px;
        padding: 10px 24px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 163, 255, 0.3);
    }

    .btn-top:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 163, 255, 0.4);
    }

    .btn-top.active {
        background: white;
        color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .icon-btn {
        color: var(--text-main);
        font-size: 20px;
        text-decoration: none;
        padding: 8px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .icon-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-main);
    }

    /* User Widget */
    .user-widget {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 999px;
        padding: 6px 10px 6px 6px;
        cursor: grab;
        user-select: none;
        position: relative;
        transition: box-shadow 0.2s ease, transform 0.2s ease;
        max-width: 170px;
    }

    .user-widget.dragging {
        cursor: grabbing;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
    }

    .user-avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: grid;
        place-items: center;
        font-weight: 700;
        font-size: 14px;
        text-transform: uppercase;
        flex: 0 0 auto;
    }

    .user-info {
        line-height: 1.1;
    }

    .user-name {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-main);
        max-width: 80px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-role {
        font-size: 10px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.4px;
    }

    .user-actions-btn {
        color: var(--text-secondary);
        font-size: 16px;
        text-decoration: none;
        padding: 4px 6px;
        border-radius: 8px;
    }

    .user-actions-btn:hover {
        color: var(--text-main);
        background: rgba(255, 255, 255, 0.04);
    }

    .user-menu {
        min-width: 220px;
        padding: 10px;
        border-radius: 12px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: #000;
    }

    .user-menu .dropdown-item {
        color: var(--text-main);
        border-radius: 8px;
        font-size: 13px;
        padding: 8px 10px;
    }

    .user-menu .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.06);
    }

    .user-meta {
        padding: 8px 10px 10px 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        margin-bottom: 8px;
    }

    .user-meta .email {
        font-size: 11px;
        color: var(--text-secondary);
        word-break: break-all;
    }

    @media (max-width: 768px) {
        .user-widget {
            width: 100%;
            justify-content: space-between;
        }
        .user-name {
            max-width: 180px;
        }
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
        grid-auto-flow: row dense;
    }

    .card-db {
        background: linear-gradient(135deg, rgba(18, 45, 57, 0.96), rgba(16, 34, 45, 0.96));
        border-radius: 10px;
        padding: 12px 14px;
        border: 1px solid rgba(120, 170, 188, 0.14);
        height: 100%;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
        display: flex;
        flex-direction: column;
    }

    .card-title {
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #d5ebf5;
        text-align: center;
    }

    .col-quarter { grid-column: span 3; min-height: 205px; }
    .col-half { grid-column: span 6; min-height: 205px; }
    .col-full { grid-column: span 12; min-height: 205px; }

    .row-split {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 10px;
        align-items: center;
    }

    .kpi-pills {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 36px;
        margin-top: 16px;
    }

    .kpi-stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }

    .kpi-value {
        border-radius: 4px;
        min-width: 56px;
        text-align: center;
        font-size: 30px;
        font-weight: 800;
        line-height: 1;
        padding: 6px 6px;
        color: #0f2b39;
    }

    .kpi-value.blue { background: #2f99eb; }
    .kpi-value.orange { background: #ffad24; min-width: 24px; font-size: 34px; padding: 4px 4px; }

    .kpi-label {
        font-size: 12px;
        color: #d6e2e9;
        font-weight: 700;
    }

    .status-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 6px;
    }

    .status-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 12px;
        color: #d7eaf2;
        font-weight: 600;
    }

    .status-info {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 0;
    }

    .center-value {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: 800;
        color: #59c769;
        pointer-events: none;
    }

    .semi-center {
        position: absolute;
        left: 50%;
        top: 68%;
        transform: translate(-50%, -50%);
        text-align: center;
        pointer-events: none;
    }

    .semi-value {
        font-size: 13px;
        font-weight: 700;
        color: #d5ebf5;
    }

    .chart-h { height: 140px; position: relative; }
    .chart-m { height: 140px; position: relative; }
    .chart-l { height: 140px; position: relative; }

    @media (max-width: 992px) {
        .top-bar {
            padding: 12px;
            gap: 10px;
        }
        .search-group {
            max-width: 100%;
        }
        .search-input-wrapper {
            max-width: 100%;
        }
        .top-actions {
            width: 100%;
            justify-content: flex-start;
        }
        .card-db {
            padding: 9px 9px;
        }
        .card-title {
            font-size: 11px;
            line-height: 1.25;
        }
    }

    @media (max-width: 1400px) {
        .col-quarter { grid-column: span 6; }
        .col-half { grid-column: span 12; }
    }

    @media (max-width: 768px) {
        .dashboard-wrapper {
            padding: 0 4px;
        }
        .col-quarter, .col-half, .col-full {
            grid-column: span 12;
        }
        .top-bar {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
            margin-bottom: 12px;
        }
        .search-group {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }
        .search-select,
        .search-input,
        #dashboardSelector {
            min-width: 100%;
            width: 100%;
            height: 42px;
            font-size: 13px;
        }
        .search-input-wrapper {
            max-width: none;
        }
        .top-actions {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }
        .btn-top,
        .icon-btn {
            width: 100%;
            justify-content: center;
        }
        .icon-btn {
            border: 1px solid var(--border-color);
            border-radius: 10px;
        }
        .row-split {
            grid-template-columns: 1fr;
            gap: 6px;
        }
        .kpi-pills {
            gap: 18px;
            margin-top: 10px;
        }
        .kpi-value {
            font-size: 24px;
            min-width: 48px;
        }
        .kpi-value.orange {
            font-size: 26px;
            min-width: 22px;
        }
        .status-item {
            font-size: 11px;
        }
        .center-value {
            font-size: 20px;
        }
        .chart-h { height: 120px; }
        .chart-m { height: 120px; }
        .chart-l { height: 120px; }
    }

    @media (max-width: 420px) {
        .card-db {
            padding: 10px 8px;
        }
        .chart-h { height: 110px; }
        .chart-m { height: 110px; }
        .chart-l { height: 110px; }
        .center-value {
            font-size: 18px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% set view = request.query_params.get('view', 'principal') %}
<div class="dashboard-wrapper">
    <!-- Top Bar -->
    <div class="top-bar">
        <form action="/clientes" method="GET" class="search-group" id="dashboardSearchForm">
            <select name="field" class="search-select" id="searchField" style="color: var(--text-main);">
                <option value="todos" style="color: var(--text-main); background: #1c2833;">Todos</option>
                <option value="endereco" style="color: var(--text-main); background: #1c2833;">EndereÃ§o</option>
                <option value="email" style="color: var(--text-main); background: #1c2833;">Email</option>
                <option value="nome" style="color: var(--text-main); background: #1c2833;">Nome</option>
                <option value="cpf/cnpj" style="color: var(--text-main); background: #1c2833;">CPF/CNPJ</option>
                <option value="login" style="color: var(--text-main); background: #1c2833;">Login</option>
            </select>
            <div class="search-input-wrapper">
                <input type="text" name="q" class="search-input" placeholder="Buscar clientes..." id="searchInput">
                <i class="bi bi-search search-icon" style="cursor: pointer;" onclick="document.getElementById('dashboardSearchForm').submit();"></i>
            </div>
        </form>
        
        <div class="top-actions">
            <select class="search-select" style="min-width: 200px;" onchange="switchDashboard(this.value)" id="dashboardSelector">
                <option value="principal" {% if not request.query_params.get('view') or request.query_params.get('view') == 'principal' %}selected{% endif %}>Dashboard principal</option>
                <option value="financeiro" {% if request.query_params.get('view') == 'financeiro' %}selected{% endif %}>Dashboard Financeiro</option>
                <option value="suporte" {% if request.query_params.get('view') == 'suporte' %}selected{% endif %}>Dashboard Suporte</option>
                <option value="vendas" {% if request.query_params.get('view') == 'vendas' %}selected{% endif %}>Dashboard Vendas</option>
                <option value="tecnico" {% if request.query_params.get('view') == 'tecnico' %}selected{% endif %}>Dashboard TÃ©cnico</option>
            </select>
            <a href="#" class="btn-top active">
                <i class="bi bi-check-circle-fill"></i> Guia NFCom
            </a>
            <a href="#" class="icon-btn"><i class="bi bi-bell"></i></a>
            <div class="dropdown">
                <div class="user-widget dropdown-toggle" id="userWidget" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">UsuÃ¡rio</div>
                        <div class="user-role" id="userRole">Perfil</div>
                    </div>
                    <span class="user-actions-btn" title="OpÃ§Ãµes">
                        <i class="bi bi-chevron-down"></i>
                    </span>
                </div>
                <div class="dropdown-menu dropdown-menu-end user-menu" aria-labelledby="userWidget">
                    <div class="user-meta">
                        <div class="fw-bold" id="userFullName">Carregando...</div>
                        <div class="email" id="userEmail">-</div>
                    </div>
                    <a class="dropdown-item" href="/minha-conta">
                        <i class="bi bi-person-gear me-2"></i> Minha conta
                    </a>
                    <a class="dropdown-item" href="/minha-conta?tab=preferencias">
                        <i class="bi bi-gear me-2"></i> PreferÃªncias
                    </a>
                    <a class="dropdown-item" href="/relatorios/clientes">
                        <i class="bi bi-bar-chart me-2"></i> RelatÃ³rios rÃ¡pidos
                    </a>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item text-danger" type="button" onclick="logout()">
                        <i class="bi bi-box-arrow-right me-2"></i> Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Ordens de servicos pendentes</div>
                <div class="chart-h">
                    <canvas id="osBarsChart"></canvas>
                </div>
                <div class="kpi-pills">
                    <div class="kpi-stack">
                        <div class="kpi-value blue" id="os-todas">4684</div>
                        <div class="kpi-label">Todas</div>
                    </div>
                    <div class="kpi-stack">
                        <div class="kpi-value orange" id="os-minhas">1</div>
                        <div class="kpi-label">Minhas</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Atendimentos por status (6354)</div>
                <div class="chart-m">
                    <canvas id="atendimentosChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Status dos contratos (25748)</div>
                <div class="row-split">
                    <div class="chart-m">
                        <canvas id="contratosGauge"></canvas>
                    </div>
                    <ul class="status-list">
                        <li class="status-item"><span class="status-info"><span class="status-dot" style="background:#49bc53;"></span>Ativos: 9542</span></li>
                        <li class="status-item"><span class="status-info"><span class="status-dot" style="background:#8ba1b1;"></span>Inativos: 15886</span></li>
                        <li class="status-item"><span class="status-info"><span class="status-dot" style="background:#2f99eb;"></span>Pre-contrato: 78</span></li>
                        <li class="status-item"><span class="status-info"><span class="status-dot" style="background:#5f6770;"></span>Desistiu: 227</span></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Contratos por status (9557)</div>
                <div class="chart-m">
                    <canvas id="contratosDonut"></canvas>
                    <div class="center-value">77%</div>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Clientes (20344)</div>
                <div class="chart-m">
                    <canvas id="clientesDonut"></canvas>
                    <div class="center-value" style="font-size: 22px;">56%</div>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Ultimos 30 dias (201)</div>
                <div class="chart-m">
                    <canvas id="trintaDiasGauge"></canvas>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Status Backup</div>
                <div class="chart-m">
                    <canvas id="backupChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Prospects (2116)</div>
                <div class="chart-m">
                    <canvas id="prospectsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-half">
            <div class="card-db">
                <div class="card-title">A receber com vencimento no mes atual (819.335,85)</div>
                <div class="chart-l">
                    <canvas id="receberGauge"></canvas>
                    <div class="semi-center">
                        <div class="semi-value">47%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-quarter">
            <div class="card-db">
                <div class="card-title">Validade do certificado A1 (03/12/26)</div>
                <div class="chart-l">
                    <canvas id="certificadoGauge"></canvas>
                </div>
            </div>
        </div>

        <div class="col-half">
            <div class="card-db">
                <div class="card-title">A pagar com vencimento no mes atual (459.237,57)</div>
                <div class="chart-l">
                    <canvas id="pagarGauge"></canvas>
                </div>
            </div>
        </div>

        <div class="col-half">
            <div class="card-db">
                <div class="card-title">Evolucao mensal dos contratos nos ultimos 365 dias</div>
                <div class="chart-l">
                    <canvas id="evolucaoChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function switchDashboard(view) {
        const url = new URL(window.location);
        url.searchParams.set('view', view);
        window.location.href = url.href;
    }

    (function applyDashboardDefault() {
        const url = new URL(window.location);
        const currentView = url.searchParams.get('view');
        if (currentView) return;
        const preferred = localStorage.getItem('dashboard_default');
        if (preferred) {
            url.searchParams.set('view', preferred);
            window.location.replace(url.href);
        }
    })();

    // ConfiguraÃ§Ã£o global do Chart.js para Dark Mode
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#adb5bd';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.08)';
    Chart.defaults.font.family = "'Inter', sans-serif";

    function initCharts() {
        const gridColor = 'rgba(106, 151, 169, 0.18)';
        const textColor = '#d5ebf5';
        const isMobile = window.matchMedia('(max-width: 768px)').matches;
        const legendFont = isMobile ? 9 : 11;
        const legendBox = isMobile ? 8 : 10;

        const noLegend = { plugins: { legend: { display: false } } };
        const axisBase = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: '#102a36' } },
            scales: {
                x: { grid: { color: gridColor }, ticks: { color: textColor, font: { size: isMobile ? 10 : 11 } } },
                y: { grid: { color: gridColor }, ticks: { color: textColor, font: { size: isMobile ? 10 : 11 } } }
            }
        };

        const osBarsCtx = document.getElementById('osBarsChart');
        if (osBarsCtx) {
            new Chart(osBarsCtx, {
                type: 'bar',
                data: {
                    labels: [''],
                    datasets: [
                        { data: [4684], backgroundColor: '#2f99eb', borderRadius: 6, barThickness: 28 },
                        { data: [1], backgroundColor: '#ffad24', borderRadius: 6, barThickness: 28 }
                    ]
                },
                options: {
                    ...noLegend,
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { display: false } },
                        y: { grid: { color: gridColor }, ticks: { color: textColor } }
                    }
                }
            });
        }

        const atendimentosCtx = document.getElementById('atendimentosChart');
        if (atendimentosCtx) {
            new Chart(atendimentosCtx, {
                type: 'bar',
                data: {
                    labels: ['Novo', '1 progresso', 'Pendente'],
                    datasets: [{
                        data: [3122, 3075, 157],
                        backgroundColor: ['#49bc53', '#2f99eb', '#ff4a42'],
                        borderRadius: 4,
                        barThickness: 14
                    }]
                },
                options: {
                    ...axisBase,
                    indexAxis: 'y',
                    scales: {
                        x: { grid: { color: gridColor }, ticks: { color: textColor } },
                        y: { grid: { display: false }, ticks: { color: textColor } }
                    }
                }
            });
        }

        const contratosGaugeCtx = document.getElementById('contratosGauge');
        if (contratosGaugeCtx) {
            new Chart(contratosGaugeCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [37, 63],
                        backgroundColor: ['#49bc53', 'rgba(167, 196, 209, 0.26)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '72%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        const contratosDonutCtx = document.getElementById('contratosDonut');
        if (contratosDonutCtx) {
            new Chart(contratosDonutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ativos', 'Bloqueio manual', 'Bloqueio auto', 'Em atraso', 'Ag. assinatura', 'Desativados'],
                    datasets: [{
                        data: [7369, 30, 1485, 656, 2, 15],
                        backgroundColor: ['#49bc53', '#ff4a42', '#ff6347', '#f7b928', '#2f99eb', '#7d8790'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '50%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'right',
                            labels: {
                                color: textColor,
                                boxWidth: legendBox,
                                boxHeight: legendBox,
                                font: { size: legendFont },
                                padding: isMobile ? 8 : 12
                            }
                        }
                    }
                }
            });
        }

        const clientesDonutCtx = document.getElementById('clientesDonut');
        if (clientesDonutCtx) {
            new Chart(clientesDonutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ativos', 'Inativos'],
                    datasets: [{
                        data: [11319, 9025],
                        backgroundColor: ['#49bc53', '#7a93a5'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '68%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'right',
                            labels: {
                                color: textColor,
                                boxWidth: legendBox,
                                boxHeight: legendBox,
                                font: { size: legendFont },
                                padding: isMobile ? 8 : 12
                            }
                        }
                    }
                }
            });
        }

        const trintaDiasGaugeCtx = document.getElementById('trintaDiasGauge');
        if (trintaDiasGaugeCtx) {
            new Chart(trintaDiasGaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Ativados', 'Meta'],
                    datasets: [{
                        data: [201, 260],
                        backgroundColor: ['#49bc53', '#ff4238'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '54%',
                    rotation: 190,
                    circumference: 290,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: textColor, boxWidth: legendBox, boxHeight: legendBox, font: { size: legendFont } }
                        }
                    }
                }
            });
        }

        const backupCtx = document.getElementById('backupChart');
        if (backupCtx) {
            new Chart(backupCtx, {
                type: 'bar',
                data: {
                    labels: ['07/02', '08/02', '09/02'],
                    datasets: [
                        { label: 'Falha', data: [0, 0, 0], backgroundColor: '#ef5350' },
                        { label: 'Sucesso', data: [1, 0, 1], backgroundColor: '#86a92f' },
                        { label: 'Somente Local', data: [0, 0, 0], backgroundColor: '#d4c74e' },
                        { label: 'Falha de Envio', data: [0, 0, 0], backgroundColor: '#f2ac2d' },
                        { label: 'Verificado', data: [0, 0, 0], backgroundColor: '#2f99eb' }
                    ]
                },
                options: {
                    ...axisBase,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: textColor, boxWidth: legendBox, boxHeight: legendBox, font: { size: legendFont } }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false }, ticks: { color: textColor } },
                        y: { stacked: true, grid: { color: gridColor }, ticks: { color: textColor, stepSize: 1 } }
                    }
                }
            });
        }

        const prospectsCtx = document.getElementById('prospectsChart');
        if (prospectsCtx) {
            new Chart(prospectsCtx, {
                type: 'bar',
                data: {
                    labels: ['Novos', 'Sondagem', 'Apresentacao', 'Negociando'],
                    datasets: [{
                        data: [100, 72, 48, 30],
                        backgroundColor: ['#2f99eb', '#9c27b0', '#f5db3b', '#f7a51f'],
                        borderWidth: 0,
                        barThickness: 22
                    }]
                },
                options: {
                    ...noLegend,
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false, reverse: true },
                        y: { display: false, reverse: true }
                    }
                }
            });
        }

        const receberGaugeCtx = document.getElementById('receberGauge');
        if (receberGaugeCtx) {
            new Chart(receberGaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Renegociados', 'Baixados', 'Cancelados', 'Abertos'],
                    datasets: [{
                        data: [2, 26, 25, 47],
                        backgroundColor: ['#f7a51f', '#49bc53', '#7a93a5', '#2f99eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '58%',
                    rotation: 270,
                    circumference: 180,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'top' : 'left',
                            labels: {
                                color: textColor,
                                boxWidth: legendBox,
                                boxHeight: legendBox,
                                font: { size: legendFont },
                                padding: isMobile ? 8 : 12
                            }
                        }
                    }
                }
            });
        }

        const certificadoGaugeCtx = document.getElementById('certificadoGauge');
        if (certificadoGaugeCtx) {
            new Chart(certificadoGaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Dias ja utilizados', 'Dias restantes'],
                    datasets: [{
                        data: [71, 296],
                        backgroundColor: ['#bedcff', '#49bc53'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '55%',
                    rotation: 270,
                    circumference: 180,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: textColor, boxWidth: legendBox, boxHeight: legendBox, font: { size: legendFont } }
                        }
                    }
                }
            });
        }

        const pagarGaugeCtx = document.getElementById('pagarGauge');
        if (pagarGaugeCtx) {
            new Chart(pagarGaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Baixados', 'Baixa parcial', 'Cancelados', 'Em aberto'],
                    datasets: [{
                        data: [29, 0, 15, 56],
                        backgroundColor: ['#49bc53', '#f5db3b', '#7a93a5', '#ff4238'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '58%',
                    rotation: 270,
                    circumference: 180,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'top' : 'left',
                            labels: {
                                color: textColor,
                                boxWidth: legendBox,
                                boxHeight: legendBox,
                                font: { size: legendFont },
                                padding: isMobile ? 8 : 12
                            }
                        }
                    }
                }
            });
        }

        const evolucaoCtx = document.getElementById('evolucaoChart');
        if (evolucaoCtx) {
            new Chart(evolucaoCtx, {
                type: 'line',
                data: {
                    labels: ['01', '04', '07', '10', '13', '16', '19', '22', '25', '28', '31'],
                    datasets: [
                        { label: 'Ativados : 3940', data: [217, 391, 457, 448, 302, 394, 356, 375, 350, 246, 138], borderColor: '#49bc53', backgroundColor: '#49bc53', tension: 0.35 },
                        { label: 'Churn : 4030', data: [889, 576, 197, 72, 279, 149, 233, 254, 231, 148, 32], borderColor: '#7a93a5', backgroundColor: '#7a93a5', tension: 0.35 },
                        { label: 'Data renovacao : 1208', data: [54, 56, 85, 72, 77, 49, 123, 121, 119, 90, 232], borderColor: '#2f99eb', backgroundColor: '#2f99eb', tension: 0.35 },
                        { label: 'Crescimento : -90', data: [-185, -120, -93, -77, -48, -56, -39, -44, -71, -8, 23], borderColor: '#9c27b0', backgroundColor: '#9c27b0', tension: 0.35 }
                    ]
                },
                options: {
                    ...axisBase,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: textColor,
                                boxWidth: legendBox,
                                boxHeight: legendBox,
                                font: { size: legendFont },
                                padding: isMobile ? 8 : 10
                            }
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(78, 113, 128, 0.14)' }, ticks: { color: textColor } },
                        y: { grid: { color: 'rgba(78, 113, 128, 0.14)' }, ticks: { color: textColor } }
                    }
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', initCharts);

    function applyUserWidgetPosition(widget) {
        const saved = localStorage.getItem('dashboard_user_widget_pos');
        if (!saved) return;
        try {
            const pos = JSON.parse(saved);
            if (typeof pos.x === 'number' && typeof pos.y === 'number') {
                widget.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
            }
        } catch (error) {
            console.warn('PosiÃ§Ã£o do usuÃ¡rio invÃ¡lida:', error);
        }
    }

    function setupUserWidgetDrag(widget) {
        let isDragging = false;
        let isPointerDown = false;
        let startX = 0;
        let startY = 0;
        let baseX = 0;
        let baseY = 0;
        const dragThreshold = 4;

        const readTransform = () => {
            const match = widget.style.transform.match(/translate\\(([-\\d.]+)px,\\s*([-\\d.]+)px\\)/);
            if (match) {
                return { x: parseFloat(match[1]), y: parseFloat(match[2]) };
            }
            return { x: 0, y: 0 };
        };

        const onMouseDown = (event) => {
            if (event.target.closest('.user-actions-btn')) return;
            isPointerDown = true;
            isDragging = false;
            const base = readTransform();
            baseX = base.x;
            baseY = base.y;
            startX = event.clientX;
            startY = event.clientY;
        };

        const onMouseMove = (event) => {
            if (!isPointerDown) return;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            if (!isDragging && Math.hypot(dx, dy) >= dragThreshold) {
                isDragging = true;
                widget.classList.add('dragging');
            }
            if (!isDragging) return;
            widget.style.transform = `translate(${baseX + dx}px, ${baseY + dy}px)`;
        };

        const onMouseUp = () => {
            if (!isPointerDown) return;
            isPointerDown = false;
            if (!isDragging) return;
            isDragging = false;
            widget.classList.remove('dragging');
            const current = readTransform();
            localStorage.setItem('dashboard_user_widget_pos', JSON.stringify(current));
        };

        widget.addEventListener('mousedown', onMouseDown);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onMouseUp);
    }

    async function hydrateUserWidget() {
        const widget = document.getElementById('userWidget');
        if (!widget) return;

        applyUserWidgetPosition(widget);
        setupUserWidgetDrag(widget);

        try {
            const response = await fetch('/api/usuarios/me');
            if (!response.ok) return;
            const user = await response.json();

            const name = user.nome_completo || user.username || 'UsuÃ¡rio';
            const email = user.email || '-';
            const role = (user.role || 'Perfil').toString();
            const initials = name
                .split(' ')
                .filter(Boolean)
                .slice(0, 2)
                .map(part => part[0])
                .join('')
                .toUpperCase();

            document.getElementById('userName').textContent = name;
            document.getElementById('userRole').textContent = role;
            document.getElementById('userFullName').textContent = name;
            document.getElementById('userEmail').textContent = email;
            const avatar = document.getElementById('userAvatar');
            if (user.foto_url) {
                avatar.textContent = '';
                avatar.style.backgroundImage = `url(${user.foto_url})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
            } else {
                avatar.style.backgroundImage = '';
                avatar.textContent = initials || 'U';
            }
        } catch (error) {
            console.error('Erro ao carregar dados do usuÃ¡rio:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', hydrateUserWidget);
</script>
{% endblock %}

