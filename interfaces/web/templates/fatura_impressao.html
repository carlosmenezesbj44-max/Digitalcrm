<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Fatura #{{ fatura.numero_fatura }} - {{ config.COMPANY_NAME }}</title>
    <!-- Google Fonts para Código de Barras e Estilo -->
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f5f5f5;
        }
        
        /* Formato de Carnê: ~15cm x 7cm */
        .carne-container {
            width: 150mm;
            height: 70mm;
            background-color: white;
            margin: 20px auto;
            border: 1px solid #ddd;
            display: flex;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        /* Linha de Corte com Tesoura */
        .corte-linha {
            position: absolute;
            left: 40mm;
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 1px dashed #999;
            z-index: 10;
        }

        .corte-linha::before {
            content: "\f533"; /* Bootstrap icon scissors */
            font-family: "bootstrap-icons";
            position: absolute;
            top: 5px;
            left: -8px;
            background: white;
            font-size: 10pt;
            color: #999;
        }

        /* Canhoto (Esquerda) */
        .canhoto {
            width: 40mm;
            padding: 4mm;
            font-size: 8pt;
            display: flex;
            flex-direction: column;
            background-color: #fafafa;
        }

        /* Boleto Principal (Direita) */
        .boleto-main {
            flex: 1;
            padding: 4mm;
            font-size: 9pt;
            display: flex;
            flex-direction: column;
        }

        .header-logo {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3mm;
            border-bottom: 2px solid #0d47a1;
            padding-bottom: 1mm;
        }

        .logo-box {
            display: flex;
            align-items: center;
            gap: 2mm;
        }

        .logo-box img {
            max-height: 8mm;
            max-width: 30mm;
        }

        .logo-text {
            font-weight: 700;
            font-size: 11pt;
            color: #0d47a1;
            text-transform: uppercase;
        }

        .recibo-label {
            font-size: 8pt;
            color: #666;
            font-weight: bold;
        }

        .info-row {
            display: flex;
            border: 1px solid #eee;
            margin-bottom: -1px; /* Collapse borders */
        }

        .info-box {
            padding: 1mm 2mm;
            border-right: 1px solid #eee;
        }

        .info-box:last-child {
            border-right: none;
        }

        .label {
            font-size: 6pt;
            color: #777;
            display: block;
            text-transform: uppercase;
            margin-bottom: 0.5mm;
        }

        .value {
            font-weight: 700;
            font-size: 8.5pt;
        }

        .instrucoes {
            flex: 1;
            margin-top: 2mm;
            padding: 1.5mm 2mm;
            font-size: 7pt;
            color: #444;
            border: 1px solid #eee;
            background-color: #fff;
            line-height: 1.2;
        }

        .pix-area {
            width: 36mm;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #eee;
            padding-left: 2mm;
        }

        .pix-qr {
            width: 28mm;
            height: 28mm;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1mm;
        }

        .pix-qr i {
            font-size: 14pt;
            color: #00bfa5;
        }

        .pix-label {
            font-size: 6pt;
            font-weight: bold;
            color: #00bfa5;
            text-align: center;
        }

        .footer-area {
            margin-top: auto;
        }

        .barcode-area {
            margin-top: 1.5mm;
            height: 12mm;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Libre Barcode 128', cursive;
            font-size: 32pt;
            color: #000;
        }

        .linha-digitavel {
            font-family: 'Courier New', Courier, monospace;
            font-size: 7.5pt;
            text-align: right;
            margin-bottom: 0.5mm;
            font-weight: bold;
        }

        .no-print {
            padding: 15px;
            text-align: center;
            background: #fff;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary { background-color: #0d47a1; color: white; }
        .btn-secondary { background-color: #666; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        @media print {
            body { background-color: white; }
            .no-print { display: none; }
            .carne-container {
                margin: 0;
                box-shadow: none;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            @page {
                size: A4;
                margin: 10mm;
            }
        }
    </style>
</head>
<body>
    <div class="no-print">
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> Imprimir Carnê
        </button>
        <button onclick="window.close()" class="btn btn-secondary">
            <i class="bi bi-x-lg"></i> Fechar
        </button>
    </div>

    <div class="carne-container">
        <div class="corte-linha"></div>

        <!-- Canhoto -->
        <div class="canhoto">
            <div style="font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 2mm; font-size: 9pt;">CANHOTO</div>
            
            <div class="info-box" style="padding: 1mm 0;">
                <span class="label">Fatura</span>
                <span class="value">#{{ fatura.numero_fatura }}</span>
            </div>
            
            <div class="info-box" style="padding: 1mm 0;">
                <span class="label">Vencimento</span>
                <span class="value">{{ fatura.data_vencimento.strftime("%d/%m/%Y") if fatura.data_vencimento else "N/A" }}</span>
            </div>
            
            <div class="info-box" style="padding: 1mm 0;">
                <span class="label">Valor</span>
                <span class="value">R$ {{ "%.2f"|format(fatura.valor_total) }}</span>
            </div>
            
            <div class="info-box" style="padding: 1mm 0;">
                <span class="label">Cliente</span>
                <span class="value" style="font-size: 7pt;">{{ fatura.cliente_nome }}</span>
            </div>

            <div style="margin-top: auto; font-size: 6pt; color: #777; border-top: 0.5px solid #eee; pt: 2mm;">
                Pagamento em: ___/___/___
                <br><br>
                _______________________
                <center>Autenticação Mecânica</center>
            </div>
        </div>

        <!-- Boleto Principal -->
        <div class="boleto-main">
            <div class="header-logo">
                <div class="logo-box">
                    {% if config.COMPANY_LOGO %}
                        <img src="{{ config.COMPANY_LOGO }}" alt="Logo">
                    {% endif %}
                    <span class="logo-text">{{ config.COMPANY_NAME }}</span>
                </div>
                <span class="recibo-label">RECIBO DO PAGADOR</span>
            </div>

            <div class="info-row">
                <div class="info-box" style="flex: 2;">
                    <span class="label">Pagador</span>
                    <span class="value">{{ fatura.cliente_nome }} - {{ fatura.cliente_cpf_cnpj }}</span>
                </div>
                <div class="info-box" style="flex: 1;">
                    <span class="label">Vencimento</span>
                    <span class="value" style="color: #d32f2f;">{{ fatura.data_vencimento.strftime("%d/%m/%Y") if fatura.data_vencimento else "N/A" }}</span>
                </div>
            </div>

            <div class="info-row">
                <div class="info-box" style="flex: 2;">
                    <span class="label">Endereço</span>
                    <span class="value" style="font-size: 7.5pt; font-weight: normal;">{{ fatura.cliente_endereco }}</span>
                </div>
                <div class="info-box" style="flex: 1;">
                    <span class="label">Valor do Documento</span>
                    <span class="value">R$ {{ "%.2f"|format(fatura.valor_total) }}</span>
                </div>
            </div>

            <div style="display: flex; gap: 2mm; flex: 1;">
                <div class="instrucoes">
                    <strong>INSTRUÇÕES (Responsabilidade do Beneficiário):</strong><br>
                    - Após {{ fatura.data_vencimento.strftime("%d/%m/%Y") if fatura.data_vencimento else "o vencimento" }}, cobrar multa de {{ config.BOLETO_MULTA_PADRAO }}% e juros de {{ config.BOLETO_JUROS_PADRAO }}% ao mês.<br>
                    - Mantenha seu sinal ativo realizando o pagamento até a data de vencimento.<br>
                    - Central de Atendimento: {{ config.COMPANY_TELEFONE or "Suporte Técnico" }}
                </div>
                
                <div class="pix-area">
                    <div class="pix-qr" id="pix-qrcode">
                        <i class="bi bi-qr-code"></i>
                    </div>
                    <span class="pix-label">PAGUE COM PIX</span>
                </div>
            </div>

            <div class="footer-area">
                <div class="linha-digitavel">
                    00190.00009 02742.700003 01234.567890 1 964100000{{ "%.0f"|format(fatura.valor_total * 100) }}
                </div>
                <div class="barcode-area">
                    {{ fatura.numero_fatura }}0000{{ "%.0f"|format(fatura.valor_total * 100) }}
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/qrcode.min.js"></script>
    <script>
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
        }

        function normalizePixKey(key, keyType) {
            const raw = String(key || '').trim();
            if (!raw) return '';

            switch ((keyType || '').toLowerCase()) {
                case 'cpf':
                case 'cnpj':
                case 'telefone':
                    return raw.replace(/\D/g, '');
                case 'email':
                    return raw.replace(/\s+/g, '').toLowerCase();
                case 'aleatoria':
                case 'evp':
                default:
                    return raw.replace(/\s+/g, '');
            }
        }

        function generatePixPayload(key, keyType, beneficiary, city, amount, txid = '***') {
            function formatField(id, value) {
                const val = String(value);
                const len = val.length.toString().padStart(2, '0');
                return `${id}${len}${val}`;
            }

            // Limpar dados para o padrão PIX
            const cleanKey = normalizePixKey(key, keyType);
            if (!cleanKey) {
                throw new Error('Chave PIX inválida');
            }
            const cleanBeneficiary = removeAccents(beneficiary || 'CRM PROVEDOR').substring(0, 25);
            const cleanCity = removeAccents(city || 'SAO PAULO').substring(0, 15);
            const cleanTxid = removeAccents(txid || '***').replace(/[^A-Z0-9]/g, '').substring(0, 25);

            const payload = [
                formatField('00', '01'), // Payload Format Indicator
                formatField('26', 
                    formatField('00', 'br.gov.bcb.pix') + 
                    formatField('01', cleanKey)
                ), // Merchant Account Information
                formatField('52', '0000'), // Merchant Category Code
                formatField('53', '986'), // Transaction Currency (BRL)
                formatField('54', parseFloat(amount).toFixed(2)), // Transaction Amount
                formatField('58', 'BR'), // Country Code
                formatField('59', cleanBeneficiary), // Merchant Name
                formatField('60', cleanCity), // Merchant City
                formatField('62', formatField('05', cleanTxid)), // Additional Data Field (TXID)
                '6304' // CRC16 Placeholder
            ].join('');

            // CRC16 CCITT (Standard para PIX)
            let crc = 0xFFFF;
            for (let i = 0; i < payload.length; i++) {
                crc ^= (payload.charCodeAt(i) << 8);
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                    else crc <<= 1;
                }
            }
            crc = (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
            
            return payload + crc;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const pixKey = "{{ config.PIX_CHAVE }}";
            const pixKeyType = "{{ config.PIX_TIPO_CHAVE or 'cpf' }}";
            const beneficiary = "{{ config.PIX_BENEFICIARIO }}";
            const city = "{{ config.PIX_CIDADE }}";
            const amount = {{ fatura.valor_total or 0 }};
            const faturaId = "{{ fatura.numero_fatura }}";

            if (pixKey) {
                const payload = generatePixPayload(pixKey, pixKeyType, beneficiary, city, amount, faturaId);
                const qrContainer = document.getElementById('pix-qrcode');
                
                // Limpar ícone e gerar QR Code
                qrContainer.innerHTML = '';
                const canvas = document.createElement('canvas');
                qrContainer.appendChild(canvas);

                QRCode.toCanvas(canvas, payload, {
                    width: 105, // Aproximadamente 28mm
                    margin: 0,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                }, function (error) {
                    if (error) {
                        console.error(error);
                        qrContainer.innerHTML = '<i class="bi bi-qr-code" style="color: #ccc;"></i>';
                    }
                });
            }
        });
    </script>

    <script>
        // Auto print when loading (optional)
        // window.onload = function() { window.print(); }
    </script>
</body>
</html>
