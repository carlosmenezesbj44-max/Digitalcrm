{% extends "layout.html" %}

{% block title %}Pagamentos - CRM Provedor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
            <h1 class="h3 mb-0" style="color: var(--text-main);"><i class="bi bi-credit-card"></i> Pagamentos</h1>
            <p style="color: var(--text-secondary); opacity: 0.8;" class="mb-0">Histórico de pagamentos recebidos</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4 border-0 shadow-sm" style="background: var(--card-bg);">
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Cliente</label>
                    <select class="form-select border-secondary bg-transparent text-white" id="filtroCliente">
                        <option value="" class="bg-dark">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Método</label>
                    <select class="form-select border-secondary bg-transparent text-white" id="filtroMetodo">
                        <option value="" class="bg-dark">Todos</option>
                        <option value="boleto" class="bg-dark">Boleto</option>
                        <option value="pix" class="bg-dark">PIX</option>
                        <option value="cartao" class="bg-dark">Cartão</option>
                        <option value="dinheiro" class="bg-dark">Dinheiro</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Data Inicial</label>
                    <input type="date" class="form-control border-secondary bg-transparent text-white" id="filtroDataInicial">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold" style="color: var(--text-main);">Data Final</label>
                    <input type="date" class="form-control border-secondary bg-transparent text-white" id="filtroDataFinal">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary border-0 shadow-sm" onclick="filtrarPagamentos()">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                    <button class="btn btn-outline-success ms-2 border-0 shadow-sm" onclick="exportarPagamentos()">
                        <i class="bi bi-download"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm h-100" style="background: var(--card-bg);">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-2" style="color: #10b981;" id="totalRecebido">R$ 0,00</h5>
                    <p class="card-text small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px;">Total Recebido (Mês)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm h-100" style="background: var(--card-bg);">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-2" style="color: #3b82f6;" id="totalPagamentos">0</h5>
                    <p class="card-text small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px;">Pagamentos (Mês)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm h-100" style="background: var(--card-bg);">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-2" style="color: #06b6d4;" id="mediaPagamento">R$ 0,00</h5>
                    <p class="card-text small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px;">Média por Pagamento</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-0 shadow-sm h-100" style="background: var(--card-bg);">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-2" style="color: #f59e0b;">0%</h5>
                    <p class="card-text small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px;">Taxa de Conversão</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Pagamentos -->
    <div class="card border-0 shadow-sm" style="background: var(--card-bg);">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table mb-0" id="tabelaPagamentos">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th class="px-4 py-3" style="color: var(--text-main);">ID</th>
                            <th class="py-3" style="color: var(--text-main);">Fatura</th>
                            <th class="py-3" style="color: var(--text-main);">Cliente</th>
                            <th class="py-3" style="color: var(--text-main);">Valor</th>
                            <th class="py-3" style="color: var(--text-main);">Método</th>
                            <th class="py-3" style="color: var(--text-main);">Data</th>
                            <th class="py-3" style="color: var(--text-main);">Referência</th>
                            <th class="px-4 py-3 text-end" style="color: var(--text-main);">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela">
                        <tr><td colspan="8" class="text-center py-5" style="color: var(--text-secondary);">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalhes do Pagamento -->
<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg" style="background: var(--card-bg);">
            <div class="modal-header border-bottom-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" style="color: var(--text-main);">Detalhes do Pagamento</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4 pb-4" id="detalhesPagamento"></div>
            <div class="modal-footer border-top-0 px-4 pb-4">
                <button type="button" class="btn btn-outline-secondary border-0 shadow-sm" data-bs-dismiss="modal" style="color: var(--text-main);">Fechar</button>
                <button type="button" class="btn btn-danger border-0 shadow-sm" onclick="estornarPagamento()">Estornar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let pagamentos = [];

    document.addEventListener('DOMContentLoaded', async function() {
        await carregarClientes();
        await carregarPagamentos();
    });

    async function carregarClientes() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/v1/clientes/?page=1&per_page=100', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                const clientes = Array.isArray(data) ? data : (data.clientes || []);
                const selectFiltro = document.getElementById('filtroCliente');
                selectFiltro.innerHTML = '<option value="">Todos</option>';
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    selectFiltro.appendChild(option);
                });
                window.clientesData = clientes;
            }
        } catch (error) {
            console.error('Erro ao carregar clientes:', error);
        }
    }

    async function carregarPagamentos() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/v1/faturamento/pagamentos/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const data = await response.json();
                pagamentos = Array.isArray(data) ? data : [];
                renderizarPagamentos(pagamentos);
                atualizarEstatisticas(pagamentos);
            } else {
                document.getElementById('corpoTabela').innerHTML = 
                    '<tr><td colspan="8" class="text-center py-5" style="color: var(--text-secondary);">Nenhum pagamento encontrado</td></tr>';
            }
        } catch (error) {
            console.error('Erro ao carregar pagamentos:', error);
            document.getElementById('corpoTabela').innerHTML = 
                '<tr><td colspan="8" class="text-center py-5 text-danger">Erro ao carregar</td></tr>';
        }
    }

    function atualizarEstatisticas(pagamentosList) {
        const hoje = new Date();
        const mesAtual = hoje.getMonth();
        const anoAtual = hoje.getFullYear();
        
        const pagamentosMes = pagamentosList.filter(p => {
            const data = new Date(p.data_pagamento);
            return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
        });

        const totalRecebido = pagamentosMes.reduce((acc, p) => acc + p.valor_pago, 0);
        const mediaPagamento = pagamentosMes.length > 0 ? totalRecebido / pagamentosMes.length : 0;

        document.getElementById('totalRecebido').textContent = `R$ ${totalRecebido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        document.getElementById('totalPagamentos').textContent = pagamentosMes.length;
        document.getElementById('mediaPagamento').textContent = `R$ ${mediaPagamento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    }

    function renderizarPagamentos(pagamentosFiltrados) {
        const corpo = document.getElementById('corpoTabela');
        corpo.innerHTML = '';

        if (pagamentosFiltrados.length === 0) {
            corpo.innerHTML = '<tr><td colspan="8" class="text-center py-5" style="color: var(--text-secondary);">Nenhum pagamento encontrado</td></tr>';
            return;
        }

        const metodoIcon = {
            'boleto': 'bi-receipt',
            'pix': 'bi-qr-code',
            'cartao': 'bi-credit-card',
            'dinheiro': 'bi-cash'
        };

        pagamentosFiltrados.forEach(pagamento => {
            const linha = `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td class="px-4 py-3" style="color: var(--text-main); font-weight: 500;">${pagamento.id}</td>
                    <td class="py-3" style="color: var(--text-main);">${pagamento.numero_fatura}</td>
                    <td class="py-3" style="color: var(--text-main); font-weight: 500;">${pagamento.cliente_nome}</td>
                    <td class="py-3" style="color: #10b981; font-weight: 600;">R$ ${pagamento.valor_pago.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="py-3" style="color: var(--text-main);"><i class="bi ${metodoIcon[pagamento.metodo_pagamento] || 'bi-cash'}"></i> ${pagamento.metodo_pagamento}</td>
                    <td class="py-3" style="color: var(--text-secondary);">${new Date(pagamento.data_pagamento).toLocaleDateString('pt-BR')}</td>
                    <td class="py-3" style="color: var(--text-secondary);">${pagamento.referencia || '-'}</td>
                    <td class="px-4 py-3 text-end">
                        <button class="btn btn-sm btn-outline-secondary border-0 shadow-sm" onclick="verDetalhes(${pagamento.id})" title="Ver Detalhes" style="color: var(--text-main);">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
            corpo.innerHTML += linha;
        });
    }

    function filtrarPagamentos() {
        const clienteId = document.getElementById('filtroCliente').value;
        const metodo = document.getElementById('filtroMetodo').value;
        const dataInicial = document.getElementById('filtroDataInicial').value;
        const dataFinal = document.getElementById('filtroDataFinal').value;

        let filtrados = pagamentos;

        if (clienteId) filtrados = filtrados.filter(p => p.cliente_id == clienteId);
        if (metodo) filtrados = filtrados.filter(p => p.metodo_pagamento === metodo);
        if (dataInicial) filtrados = filtrados.filter(p => p.data_pagamento >= dataInicial);
        if (dataFinal) filtrados = filtrados.filter(p => p.data_pagamento <= dataFinal);

        renderizarPagamentos(filtrados);
    }

    function verDetalhes(pagamentoId) {
        const pagamento = pagamentos.find(p => p.id === pagamentoId);
        if (!pagamento) return;

        const detalhes = `
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">ID</label>
                        <div style="color: var(--text-main); font-weight: 500;">${pagamento.id}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">Fatura</label>
                        <div style="color: var(--text-main); font-weight: 500;">${pagamento.numero_fatura}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">Cliente</label>
                        <div style="color: var(--text-main); font-weight: 500;">${pagamento.cliente_nome}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">Valor</label>
                        <div style="color: #10b981; font-weight: 600;">R$ ${pagamento.valor_pago.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">Método</label>
                        <div style="color: var(--text-main); font-weight: 500;">${pagamento.metodo_pagamento}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">Data</label>
                        <div style="color: var(--text-main); font-weight: 500;">${new Date(pagamento.data_pagamento).toLocaleDateString('pt-BR')}</div>
                    </div>
                    <div class="mb-3">
                        <label class="small text-uppercase fw-bold" style="color: var(--text-secondary); letter-spacing: 0.5px; font-size: 0.7rem;">Referência</label>
                        <div style="color: var(--text-main); font-weight: 500;">${pagamento.referencia || 'N/A'}</div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('detalhesPagamento').innerHTML = detalhes;
        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    }

    function estornarPagamento() {
        showToast('Funcionalidade em desenvolvimento', 'warning');
    }

    function exportarPagamentos() {
        exportToCSV(pagamentos, 'pagamentos');
    }
</script>
{% endblock %}
