{% extends "layout.html" %}

{% block title %}Configurações do Contrato - CRM Provedor{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1"><i class="bi bi-file-text me-2"></i>Configurações do Contrato</h1>
            <p class="text-muted mb-0">Gerencie os dados da sua empresa para os contratos</p>
        </div>
    </div>

    <!-- Nav tabs -->
    <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="configuracoes-tab" data-bs-toggle="tab" data-bs-target="#configuracoes" type="button" role="tab" aria-controls="configuracoes" aria-selected="true">Configurações Atuais</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="empresa-tab" data-bs-toggle="tab" data-bs-target="#empresa" type="button" role="tab" aria-controls="empresa" aria-selected="false">Dados da Empresa</button>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content" id="configTabsContent">
        <!-- Configurações Tab -->
        <div class="tab-pane fade show active" id="configuracoes" role="tabpanel" aria-labelledby="configuracoes-tab">
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-info border-0 shadow-sm mb-4">
                        <div class="d-flex">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <div>
                                <strong>Nota:</strong> Estas são as configurações básicas. Use a aba "Dados da Empresa" para editar as informações detalhadas.
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <h5 class="mb-3">Configurações de Exibição</h5>
                            <div class="mb-3">
                                <label class="text-muted small d-block">Nome (Display)</label>
                                <span id="displayCompanyName" class="fw-bold">{{ company_name or 'Não definido' }}</span>
                            </div>
                            <div>
                                <label class="text-muted small d-block mb-2">Logo Atual</label>
                                <div id="displayLogo" class="p-3 border rounded text-center bg-dark-soft">
                                    {% if company_logo %}
                                    <img src="{{ company_logo }}" alt="Logo da empresa" style="max-height: 100px; object-fit: contain;" id="displayCompanyLogo">
                                    {% else %}
                                    <span class="text-muted">Não definido</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3">Template HTML</h5>
                            <div class="bg-dark-soft p-3 border rounded">
                                <pre class="mb-0 text-light" style="white-space: pre-wrap; font-family: 'Fira Code', monospace; font-size: 12px; max-height: 300px; overflow-y: auto;">{{ contract_template_html or 'Não definido' }}</pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-5">
                        <h5 class="mb-3">Placeholders Disponíveis</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush bg-transparent">
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_nome}}</code> - Nome Fantasia</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_razao_social}}</code> - Razão Social</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_cnpj}}</code> - CNPJ</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_ie}}</code> - Inscrição Estadual</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_endereco}}</code> - Endereço</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush bg-transparent">
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_telefone}}</code> - Telefone</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_email}}</code> - E-mail</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{empresa_logo}}</code> - Logo (HTML img)</li>
                                    <li class="list-group-item bg-transparent px-0 border-db"><code>{{data_atual}}</code> - Data de hoje</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empresa Tab -->
        <div class="tab-pane fade" id="empresa" role="tabpanel" aria-labelledby="empresa-tab">
            <div class="card">
                <div class="card-header border-bottom-0 pt-4 px-4">
                    <h5 class="card-title mb-0">Editar Dados da Empresa</h5>
                </div>
                <div class="card-body p-4">
                    <div id="alertSuccess" class="alert alert-success d-none">Dados salvos com sucesso!</div>
                    <div id="alertError" class="alert alert-danger d-none">Erro ao salvar os dados.</div>

                    <form id="formEmpresa">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Nome Fantasia</label>
                                <input type="text" class="form-control" id="companyName" name="COMPANY_NAME">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Razão Social</label>
                                <input type="text" class="form-control" id="companyRazaoSocial" name="COMPANY_RAZAO_SOCIAL">
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">CNPJ</label>
                                <input type="text" class="form-control" id="companyCnpj" name="COMPANY_CNPJ">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Inscrição Estadual</label>
                                <input type="text" class="form-control" id="companyIe" name="COMPANY_IE">
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">E-mail</label>
                                <input type="email" class="form-control" id="companyEmail" name="COMPANY_EMAIL">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Telefone</label>
                                <input type="text" class="form-control" id="companyTelefone" name="COMPANY_TELEFONE">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-muted small">Endereço Completo</label>
                            <input type="text" class="form-control" id="companyEndereco" name="COMPANY_ENDERECO">
                        </div>
                        
                        <div class="row g-3 mb-4 align-items-center">
                            <div class="col-md-8">
                                <label class="form-label text-muted small">Logo da Empresa</label>
                                <input type="file" class="form-control" id="logoInput" accept="image/*" onchange="uploadLogo()">
                                <input type="hidden" id="companyLogo" name="COMPANY_LOGO">
                                <small class="text-muted">Formatos aceitos: PNG, JPG, SVG.</small>
                            </div>
                            <div class="col-md-4 text-center">
                                <div id="logoPreviewContainer" class="p-3 border rounded bg-dark-soft d-none">
                                    <img id="companyLogoPreview" src="" alt="Preview" style="max-height: 80px; max-width: 100%; object-fit: contain;">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-primary px-4" onclick="salvarEmpresa()">
                                <i class="bi bi-save me-2"></i>Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', carregarDadosEmpresa);

    async function carregarDadosEmpresa() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/configuracoes/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Preencher formulário
                document.getElementById('companyName').value = data.COMPANY_NAME || '';
                document.getElementById('companyRazaoSocial').value = data.COMPANY_RAZAO_SOCIAL || '';
                document.getElementById('companyCnpj').value = data.COMPANY_CNPJ || '';
                document.getElementById('companyIe').value = data.COMPANY_IE || '';
                document.getElementById('companyEmail').value = data.COMPANY_EMAIL || '';
                document.getElementById('companyTelefone').value = data.COMPANY_TELEFONE || '';
                document.getElementById('companyEndereco').value = data.COMPANY_ENDERECO || '';
                document.getElementById('companyLogo').value = data.COMPANY_LOGO || '';

                if (data.COMPANY_LOGO) {
                    const preview = document.getElementById('companyLogoPreview');
                    preview.src = data.COMPANY_LOGO;
                    document.getElementById('logoPreviewContainer').classList.remove('d-none');
                }
            }
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
        }
    }

    async function uploadLogo() {
        const input = document.getElementById('logoInput');
        if (!input.files || input.files.length === 0) return;

        const formData = new FormData();
        formData.append('file', input.files[0]);

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/configuracoes/logo', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('companyLogo').value = data.logo_url;
                document.getElementById('companyLogoPreview').src = data.logo_url;
                document.getElementById('logoPreviewContainer').classList.remove('d-none');
                
                // Show success toast instead of alert if possible, but keeping alert for now
                alert('Logo carregado com sucesso!');
            }
        } catch (error) {
            console.error('Erro no upload:', error);
        }
    }

    async function salvarEmpresa() {
        const formData = new FormData(document.getElementById('formEmpresa'));
        const data = {};
        formData.forEach((value, key) => { data[key] = value; });

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/configuracoes/', {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(data)
            });

            const alertSuccess = document.getElementById('alertSuccess');
            const alertError = document.getElementById('alertError');

            if (response.ok) {
                alertSuccess.classList.remove('d-none');
                alertError.classList.add('d-none');
                
                // Atualizar display
                document.getElementById('displayCompanyName').textContent = data.COMPANY_NAME;
                if (data.COMPANY_LOGO) {
                    document.getElementById('displayLogo').innerHTML = `<img src="${data.COMPANY_LOGO}" style="max-height: 100px; object-fit: contain;">`;
                }

                setTimeout(() => alertSuccess.classList.add('d-none'), 3000);
            } else {
                alertError.classList.remove('d-none');
                alertSuccess.classList.add('d-none');
            }
        } catch (error) {
            console.error('Erro ao salvar:', error);
        }
    }
</script>
{% endblock %}
